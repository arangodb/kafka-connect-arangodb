version: 2.1

executors:
  j11:
    docker:
      - image: 'cimg/openjdk:11.0'
  j17:
    docker:
      - image: 'cimg/openjdk:17.0'
  j20:
    docker:
      - image: 'cimg/openjdk:20.0'

jobs:
  test:
    parameters:
      jdk:
        type: 'string'
        default: 'j17'
      topology:
        type: 'string'
      arango-version:
        type: 'string'
        default: '3.11.2'
      kafka-connect-host:
        type: 'string'
        default: 'http://172.28.0.1:18083'
      arango-endpoints:
        type: 'string'
        default: '172.28.0.1:8529,172.28.0.1:8539,172.28.0.1:8549'
      ssl:
        type: 'boolean'
        default: false
      it-tests:
        type: 'string'
        default: ''
    executor: <<parameters.jdk>>
    steps:
      - checkout
      - run:
          name: Package
          command: mvn package
      - setup_remote_docker
      - run:
          name: Create Kafka Environment
          command: ./docker/create_network.sh && ./docker/start_kafka.sh && ./docker/start_schema_registry.sh && ./docker/start_kafka_connect.sh
      - run:
          name: Start Database
          command: ./docker/start_db.sh
          environment:
            SSL: <<parameters.ssl>>
            STARTER_MODE: <<parameters.topology>>
            DOCKER_IMAGE: docker.io/arangodb/arangodb:<<parameters.arango-version>>
      - run:
          name: Integration Tests
          command: mvn -e --no-transfer-progress integration-test -Dkafka.connect.host=$KAFKA_CONNECT_HOST -Darango.endpoints=$ARANGO_ENDPOINTS -DSslTest=$SSL -Dit.test=$IT_TESTS
          environment:
            KAFKA_CONNECT_HOST: <<parameters.kafka-connect-host>>
            ARANGO_ENDPOINTS: <<parameters.arango-endpoints>>
            SSL: <<parameters.ssl>>
            IT_TESTS: <<parameters.it-tests>>

workflows:
  test-standalone:
    jobs:
      - test:
          matrix:
            parameters:
              topology:
                - single
              kafka-connect-host:
                - http://127.0.0.1:8083
              arango-endpoints:
                - 172.28.0.1:8529
  test-cluster:
    jobs:
      - test:
          matrix:
            parameters:
              jdk:
                - j11
                - j17
              topology:
                - cluster
  test-ssl:
    jobs:
      - test:
          matrix:
            parameters:
              topology:
                - cluster
              ssl:
                - true
              it-tests:
                - com.arangodb.kafka.SslIT
